version: '3.8'

x-airflow-common:
  &airflow-common
  build: .
  env_file:
    - .env
  environment:
    &airflow-common-env
    # --- Airflow Core Config ---
    AIRFLOW__CORE__EXECUTOR: LocalExecutor
    AIRFLOW__CORE__FERNET_KEY: ''
    AIRFLOW__CORE__DAGS_ARE_PAUSED_AT_CREATION: 'true'
    AIRFLOW__CORE__LOAD_EXAMPLES: 'false'
    AIRFLOW__CORE__DAGS_FOLDER: /opt/airflow/dags
    AIRFLOW__WEBSERVER__EXPOSE_CONFIG: 'true'

    # --- Airflow DB Connection (External MySQL) ---
    # ðŸ‘‡ Update this line with your actual MySQL server IP/hostname and credentials
    AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: >-
      mysql+mysqldb://airflow:airflow@172.20.42.143:3306/airflow

    # Optional: prevent strict mode issues
    AIRFLOW__DATABASE__LOAD_DEFAULT_CONNECTIONS: 'false'

  volumes:
    - ./dags:/opt/airflow/dags
    - ./logs:/opt/airflow/logs
    - ./plugins:/opt/airflow/plugins
  user: "${AIRFLOW_UID:-50000}:0"

services:
  # -------------------------------
  # âœ… Airflow Init (DB + Admin User)
  # -------------------------------
  airflow-init:
    <<: *airflow-common
    command: >
      bash -c "airflow db init &&
               airflow users create
               --username airflow
               --password airflow
               --firstname Air
               --lastname Flow
               --role Admin
               --email admin@example.com"
    restart: "no"

  # -------------------------------
  # âœ… Airflow Webserver
  # -------------------------------
  airflow-webserver:
    <<: *airflow-common
    command: webserver
    ports:
      - "8080:8080"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/health || exit 1"]
      interval: 10s
      retries: 5
    restart: always

  # -------------------------------
  # âœ… Airflow Scheduler
  # -------------------------------
  airflow-scheduler:
    <<: *airflow-common
    command: scheduler
    restart: always

  # -------------------------------
  # âœ… Airflow Triggerer (optional)
  # -------------------------------
  airflow-triggerer:
    <<: *airflow-common
    command: triggerer
    restart: always
